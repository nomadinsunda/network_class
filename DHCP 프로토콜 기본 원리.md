# 📡 DHCP 완전 정복: IP 주소는 어떻게 자동으로 할당될까?

> 네트워크 엔지니어, 시스템 관리자, 백엔드 개발자를 위한 DHCP(Dynamic Host Configuration Protocol)의 전문가 수준 이해

---

## 🧭 들어가며: 왜 DHCP가 필요한가?

우리가 인터넷에 접속할 때, 마치 휴대전화에 고유 전화번호가 있듯 \*\*인터넷에서도 고유 주소(IP 주소)\*\*가 필요합니다. 그런데 이 IP 주소를 **수동으로 매번 설정한다면 얼마나 번거로울까요?**

이를 자동화한 프로토콜이 바로 \*\*DHCP(Dynamic Host Configuration Protocol)\*\*입니다.

---

## 📘 DHCP란?

DHCP는 **IP 주소와 네트워크 설정을 자동으로 할당**하는 프로토콜입니다.
이는 **RFC 2131**에 의해 정의되어 있으며, 일반적으로 다음 정보를 제공합니다:

* IP 주소
* 서브넷 마스크 (Subnet Mask)
* 기본 게이트웨이 (Default Gateway)
* DNS 서버 주소
* 임대 기간(Lease Time)

> ✅ DHCP는 "임대(Lease)" 개념을 기반으로 작동합니다. 즉, **IP 주소를 영구히 주는 것이 아니라 일정 시간 동안만 사용**하도록 허용합니다.

---

## 🧪 DHCP의 핵심 개념

| 개념                     | 설명                               |
| ---------------------- | -------------------------------- |
| **DHCP 서버**            | IP 주소와 기타 네트워크 설정을 할당해주는 서버      |
| **DHCP 클라이언트**         | IP 주소를 요청하는 장치 (PC, 스마트폰, 라우터 등) |
| **임대 기간 (Lease Time)** | 클라이언트가 IP 주소를 사용할 수 있는 시간        |
| **갱신 (Renewal)**       | 임대 시간이 만료되기 전에 주소를 계속 사용하기 위한 요청 |
| **반납 (Release)**       | 더 이상 IP 주소가 필요 없는 경우 반환 절차       |

---

## 📡 DHCP 동작 흐름 (DORA 프로세스)

<img src="./images/dhcp_prod.png" width=90% /><br>

DHCP는 4단계 메시지 교환으로 구성됩니다. 이 과정을 흔히 **DORA**(Discover → Offer → Request → Ack)라고 부릅니다.

### 🧭 1. DHCP Discover

| 항목         | 설명                                              |
| ---------- | ----------------------------------------------- |
| **방향**     | 클라이언트 → 브로드캐스트                                  |
| **MAC 주소** | FF\:FF\:FF\:FF\:FF\:FF (브로드캐스트)                 |
| **목적**     | “이 네트워크에 DHCP 서버 있나요?” 클라이언트가 DHCP 서버를 찾기 위해 요청 |
| **핵심 정보**  | 클라이언트의 MAC 주소 포함                                |

🔍 *DHCP 클라이언트는 아직 IP 주소를 모르므로, IP도 MAC도 브로드캐스트해야 한다.*

---

### 📬 2. DHCP Offer

| 항목                               | 설명                                 |
| -------------------------------- | ---------------------------------- |
| **방향**                           | DHCP 서버 → 브로드캐스트 or 유니캐스트          |
| **조건**                           | 클라이언트가 설정한 Broadcast Flag 값에 따라 다름 |
| **목적**                           | DHCP 서버가 “내가 할당해줄 IP 있어요\~”라고 응답   |
| **핵심 정보**                        |                                    |
| - Your IP                        | 제안된 IP 주소                          |
| - Subnet Mask (옵션 1)             |                                    |
| - Router(Default Gateway, 옵션 3)  |                                    |
| - DNS 서버 (옵션 6)                  |                                    |
| - Lease Time (옵션 51)             |                                    |
| - DHCP Server Identifier (옵션 54) |                                    |

🔍 *여러 DHCP 서버가 Offer를 보낼 수 있으므로, 클라이언트는 선택할 수 있음.*

---

### 🙋‍♂️ 3. DHCP Request

| 항목                                                | 설명                     |
| ------------------------------------------------- | ---------------------- |
| **방향**                                            | 클라이언트 → 브로드캐스트         |
| **목적**                                            | 특정 DHCP 서버에게 IP 임대를 요청 |
| **핵심 정보**                                         |                        |
| - Requested IP Address (옵션 50): 원하는 IP 주소         |                        |
| - DHCP Server Identifier (옵션 54): 선택한 DHCP 서버의 IP |                        |

🔍 *DHCP 클라이언트는 명시적으로 “이 IP를 이 서버로부터 받고 싶어요”라고 지정한다.*

---

### ✅ 4. DHCP Ack

| 항목                       | 설명                            |
| ------------------------ | ----------------------------- |
| **방향**                   | DHCP 서버 → 브로드캐스트 or 유니캐스트     |
| **목적**                   | DHCP 서버가 클라이언트에게 IP 임대를 최종 확정 |
| **핵심 정보**                |                               |
| - Your IP                |                               |
| - Subnet Mask            |                               |
| - Router                 |                               |
| - DNS                    |                               |
| - Lease Time             |                               |
| - DHCP Server Identifier |                               |

🔍 *이 메시지를 받은 후, 클라이언트는 해당 IP 주소로 네트워크 사용 가능.*

---

## 🌀 DHCP 전체 메시지 시퀀스 다이어그램

```
클라이언트                           DHCP 서버
   |                                     |
   | -------- DHCP Discover -----------> |  (브로드캐스트)
   |                                     |
   | <---------- DHCP Offer -----------  |  (유니/브로드캐스트)
   |                                     |
   | -------- DHCP Request ------------> |  (브로드캐스트)
   |                                     |
   | <---------- DHCP Ack -------------- |  (유니/브로드캐스트)
   |                                     |
```

---

## 🛠️ DHCP 추가 개념

### 🔄 IP 주소 갱신 (Renewal)

* 클라이언트는 임대 시간이 50% 경과되면 서버에게 **DHCP Request**를 통해 갱신 요청
* 서버는 **DHCP Ack**로 연장 승인

### 🗑️ IP 주소 반납 (Release)

* 클라이언트가 더 이상 IP가 필요 없는 경우, **DHCP Release** 메시지 전송

---

## 🧠 DHCP의 장점

* ✔️ **자동화**: 대규모 네트워크에서 IP 설정을 수동으로 하지 않아도 됨
* ✔️ **중앙 관리**: IP, 게이트웨이, DNS 등을 중앙 DHCP 서버에서 통제
* ✔️ **효율적 주소 관리**: 유휴 IP 주소 회수 및 재할당 가능

---

## ⚠️ 보안 이슈

| 공격 유형           | 설명                               |
| --------------- | -------------------------------- |
| DHCP 스푸핑        | 악의적인 서버가 DHCP Offer를 보내 IP 주소 탈취 |
| DHCP Starvation | 수많은 DHCP Discover를 보내 IP 풀 고갈 유도 |

🔐 **보안 대책**: DHCP Snooping, 포트 보안, ACL 정책 등 네트워크 보안 기법을 적용해야 함

---



## 📚 참고 자료

* [RFC 2131 - Dynamic Host Configuration Protocol (IETF)](https://datatracker.ietf.org/doc/html/rfc2131)
* Cisco Networking Academy 자료
* Wireshark DHCP 패킷 분석 예제

